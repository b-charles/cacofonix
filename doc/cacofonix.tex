\documentclass{article}

% PACKAGES
\usepackage{color}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{listings}
\usepackage{xspace}
\usepackage{dingbat}
\usepackage{graphics}
\usepackage[inline]{asymptote}
\usepackage{subfig}

% ASYMPTOTE & SUBFIG
\makeatletter
\newsavebox{\sfe@box}
\newenvironment{subfloatenv}[1]{%
\def\sfe@caption{#1}%
\setbox\sfe@box\hbox\bgroup\color@setgroup}%
{\color@endgroup\egroup\subfloat[\sfe@caption]%
{\usebox{\sfe@box}}}
\makeatother

% COMMANDS
\newcommand{\cacofonix}{\textsc{Cacofonix}\xspace}
\newcommand{\matlab}{\textsc{Matlab}\xspace}

\newcommand{\note}{\lstinline!Note!\xspace}

\newcommand{\frerejaques}{\emph{Fr\`ere Jacques}\xspace}

\newcommand{\file}[1]{\texttt{#1}\xspace}
\newcommand{\noteFile}{\file{Note.m}}
\newcommand{\cacofonixFile}{\file{cacofonix.m}}
\newcommand{\noteInitFile}{\file{NoteInit.m}}
\newcommand{\noteInitFrFile}{\file{NoteInit\_fr.m}}
\newcommand{\midi}{\file{.midi}}

\newcommand{\wikipedia}{\textsc{Wikipedia}\xspace}
\newcommand{\wiktionary}{\textsc{Wiktionary}\xspace}
\newcommand{\google}{\textsc{Google}\xspace}

\newcommand{\ie}{\emph{i.e.}\xspace}
\newcommand{\eg}{\emph{e.g.}\xspace}

\newcommand{\footurl}[1]{\footnote{\url{#1}}\xspace}
\newcommand{\exchange}[2]{\texttt{#1}\footnote{\url{#2}}\xspace}

\newcommand\sfz{s$\!f\!$z\xspace}

% ME AND MYSELF
\definecolor{mecolor}{rgb}{1,0.25,0.25}
\definecolor{myselfcolor}{rgb}{0.25,0.25,1}
\newenvironment{meenv}{ \par \noindent \makebox[6em][r]{ \textcolor{mecolor}{Me}: `` --~}}{~''}
\newenvironment{myselfenv}{ \par \noindent \makebox[6em][r]{ \textcolor{myselfcolor}{Myself}: `` --~}}{~''}
\newcommand{ \me }[1]{%
\begin{meenv}%
	#1%
\end{meenv} }
\newcommand{ \myself }[1]{%
\begin{myselfenv}%
	#1%
\end{myselfenv} }

% MATLAB CODE
\definecolor{matlabcolor}{rgb}{0,0.5,0.5}
\lstset{ basicstyle=\color{matlabcolor}\ttfamily, literate={~}{$\sim$}1 {>>}{$\gg$}1, tabsize=4, numbers=left, numberstyle=\tiny\color{black}, stepnumber=3, numbersep=5pt, numberfirstline=false, firstnumber=1 }

% ASYMPTOTE
\begin{asydef}
import graph;

// pitch transitions
real tstart = 1; real tend = 6;
real t0 = 2; real p0 = 1;
real t1 = 5; real p1 = 5;

real pitchTransNone( real t ) { return p0; }
real pitchTransLinear( real t ) { return (p1-p0)*(t-t0)/(t1-t0) + p0; }
real pitchTransQuad( real t ) { return (p1-p0)*((t-t0)^2)/((t1-t0)^2) + p0; }
real pitchTransQuad2( real t ) { return (p0-p1)*((t-t1)^2)/((t0-t1)^2) + p1; }

void displayPitchTransition( real transi(real) ){
	size(5cm,3cm,false);
	draw( graph( transi, t0, t1 )--(t1,p1) );
	draw( (tstart,p0)--(t0,p0)^^(t1,p1)--(tend,p1), gray+dashed );
	xaxis( "time" );
	yaxis( "pitch" );
}

\end{asydef}

\title{\cacofonix user's guide}
\author{by B}
\date{}

\begin{document}

\maketitle

\me{Hi!}
\myself{Hello!}

\paragraph{}

\emph{Welcome. I and my inner voices will try to explain the features of \cacofonix. I realize my English is far to be perfect and I will be grateful of any suggestion to improve this document.}

\tableofcontents

\section{Foreword}

\cacofonix is a \matlab program, helping to write midi files.

\me{Who are the target customers? Who needs help to write midi files? Who thinks about \matlab to create a midi file? Who wakes up the morning and says ``Hoho! Today, I'm going to create a midi file. I think the easiest way is use \matlab and an underground library.''?}
\myself{Well, a lot of softwares for editing music and creating midi files exist, free or not, and are more attractive, intuitive, flexible and for better results. Nevertheless, \cacofonix was inspired from \exchange{Theme from Super Mario Brother Song}{http://www.mathworks.com/matlabcentral/fileexchange/8442}, a little project found on the \textsc{Matlab Central}, and the first midi files I produced was some themes from Zelda. So, I guess \cacofonix was created for \matlab geeks\dots}
\me{That's cool. One day, they'll rule the world.}

\paragraph{}

To read this document, you need know some music theory and \matlab bases: at least, read a music sheet and, \matlab side, know what is a script, a function, an array, maybe an object\dots Advanced users know what to do with \lstinline!addpath!, but the easiest way to use \cacofonix is to set the \matlab current directory to the directory of codes (\noteFile and \cacofonixFile).

\section{Tutorial}

To see how \cacofonix works, we will try to transcode this sheet (\frerejaques, a famous French nursery melody):\\
\begin{lilypond}
	\relative c'' { \new Staff { \key g \major \time 2/4 g4 a b g b c d2 d8. e16 d8 c b4 g g d g2 } }
\end{lilypond}

\subsection{Dummy code}

To create a playable note, you have to create two \note objects, one for the tonality, one for the duration, and associate them with the operator \lstinline!:!:
\begin{lstlisting}
mynote = Note('G'):Note(1);
\end{lstlisting}
This instruction creates a G quarter note (\lstinline!Note(4)! for a whole note). Per default, a note without tonality is a rest (but it's a good idea to use \lstinline!Note('rest')!), and, well, a note without duration is not played.

To have a G note (or any other note\dots) of an another octave, you have to use the unary operators \lstinline!-! and \lstinline!+!. \\
\begin{lilypond}
	\relative c' { \new Staff { b1 c a' c c'} }
\end{lilypond}
\begin{lstlisting}
sheet = [ ...
	-Note('B'):Note(4) ...
	Note('C'):Note(4) ...
	Note('A'):Note(4) ...
	+Note('C'):Note(4) ...
	++Note('C'):Note(4) ];
\end{lstlisting}

A complete sheet is just an array of \note objects. So, this is a first (and very dummy) version of \frerejaques:
\begin{lstlisting}
sheet = [ ...
	Note('G'):Note(1) Note('A'):Note(1) ...
	Note('B'):Note(1) Note('G'):Note(1) ...
	Note('B'):Note(1) +Note('C'):Note(1) ...
	+Note('D'):Note(2) ...
	+Note('D'):Note(3/4) +Note('E'):Note(1/4) ...
	+Note('D'):Note(1/2) +Note('C'):Note(1/2) ...
	Note('B'):Note(1) Note('G'):Note(1) ...
	Note('G'):Note(1) Note('D'):Note(1) ...
	Note('G'):Note(2) ];
\end{lstlisting}

The final step, to create the midi files, is to call the \lstinline!cacofonix! function, with setting the name of the file and the tempo:
\begin{lstlisting}
cacofonix( 'FrereJacques', 'Tempo', 100, sheet );
\end{lstlisting}

Theoretically, a file \file{FrereJacques.mid} has been created in the current directory and you can open it with your favorite player.

\subsection{Predefinition of some \note objects}

A way of simplifying the writing of a sheet is predefine some \note objects. Two scripts are proposed to initialize \matlab before the creation of sheets: \noteInitFile and \noteInitFrFile. Of course, with a little practrice, you should be able to create your own initialization file. This is an extract of \noteInitFile:
\begin{lstlisting}
R = Note( 'rest' );

Cf = Note( 'Cf' ); C = Note( 'C' ); Cs = Note( 'Cs' );
Df = Note( 'Df' ); D = Note( 'D' ); Ds = Note( 'Ds' );
Ef = Note( 'Ef' ); E = Note( 'E' ); Es = Note( 'Es' );
Ff = Note( 'Ff' ); F = Note( 'F' ); Fs = Note( 'Fs' );
Gf = Note( 'Gf' ); G = Note( 'G' ); Gs = Note( 'Gs' );
Af = Note( 'Af' ); A = Note( 'A' ); As = Note( 'As' );
Bf = Note( 'Bf' ); B = Note( 'B' ); Bs = Note( 'Bs' );

N = Note( 4 );
N2 = Note( 2 );
N4 = Note( 1 );
N8 = Note( 1/2 );
N16 = Note( 1/4 );
N12 = Note( 1/3 );
\end{lstlisting}

In the real \noteInitFile, some other \note objects are instanced also. So, \frerejaques becomes:
\begin{lstlisting}
NoteInit
N8dotted = Note( 3/4 );

sheet = [ ...
	G:N4 A:N4 ...
	B:N4 G:N4 ...
	B:N4 +C:N4 ...
	+D:N2 ...
	+D:N8dotted +E:N16 +D:N8 +C:N8 ...
	B:N4 G:N4 ...
	G:N4 D:N4 ...
	G:N2 ];
\end{lstlisting}

\me{Nice. Why each measure is on a line? Again a whim?}
\myself{I think it's a good practice to separate each measure on a different line: bigger projects become more readable, specially with the bars and markers functionalities of \note.}

\subsection{Bars}

\cacofonix is able to check some common mistakes, like a measure with the wrong duration, but it needs bars.

A bar object is constructed with \lstinline!Note('bar')!. It's a very useful feature, so a \lstinline!bar! object is defined in \noteInitFile.

With bars, our example becomes:
\begin{lstlisting}
NoteInit
N8dotted = Note( 3/4 );

sheet = [ ...
	G:N4 A:N4 bar ...
	B:N4 G:N4 bar ...
	B:N4 +C:N4 bar ...
	+D:N2 bar ...
	+D:N8dotted +E:N16 +D:N8 +C:N8 bar ...
	B:N4 G:N4 bar ...
	G:N4 D:N4 bar ...
	G:N2 bar ];
\end{lstlisting}

\me{Always adding \lstinline!bar! at each measure, it's a little boring, isn't it?}
\myself{Yes. But something like \exchange{EditorMacro}{http://www.mathworks.com/matlabcentral/fileexchange/24615} (and probably the new \exchange{\matlab editor API}{http://blogs.mathworks.com/desktop/2011/05/16/matlab-editor-api-examples/}) can be helpful.}

\subsection{Dotted notes}
\label{sec:TutoDottedNotes}

In the last version of \frerejaques, a special \note object has been created to represent a dotted eighth note: \lstinline!N8dotted = Note(3/4);!, but the operator \lstinline!ctranspose! (\lstinline!'!) can be used to add the half duration of the note. For example: \\
\begin{lilypond}
	\relative c'' { \new Staff { \time 2/4 g4. g8 g8. g16 g8. g16 g4.. g16 } }
\end{lilypond}

\begin{lstlisting}
NoteInit

sheet = [ ...
	G:N4' G:N8 bar ...
	G:N8' G:N16 G:N8' G:N16 bar ...
	G:N4'' G:N16 bar ];
\end{lstlisting}

\subsection{Ties and slurs}

Ties and slurs are written with the same operator: \lstinline!not! (\lstinline!~!). The operator can be used on one note to merge it with the previous: \lstinline![G:N2 ~G:N8]!. The operator can also be used on an array of notes to play legato: \lstinline!~[C:N4 E:N4 G:N4 +C:N4]!.

\me{There are an another way to create a note with an exotic duration.}
\begin{myselfenv}%
	Yes, but the good way is always use the operators \lstinline!'! and \lstinline!~!.%
\end{myselfenv}
\begin{meenv}%
	And the convenient way is use an array for the duration with the operator \lstinline!:!, like that: \lstinline!G:[N4 N16]!.%
\end{meenv}

\subsection{Chord}

A chord is a note with several tonalities and one duration. There are two ways to create a chord: a good one, the operator \lstinline!plus! (\lstinline!+!), and a bad-but-sometimes-convenient one, using an array with the operator \lstinline!colon! (you know, \lstinline!:!). \\
\begin{lilypond}
	\relative c' { \new Staff { \time 2/4 <c e g c>2 <g' b d g> <c, e g c> <g' b d g>4( <g b d g>8)( <g b d g> ) } }
\end{lilypond}

\begin{lstlisting}
NoteInit
sheet = [ ...
	C+E+G++C:N2 bar ...
	G+B++D++G:N2 bar ...
	[C E G +C]:N2 bar ...
	[G B +D +G]:[N4 N8 N8] bar ];
\end{lstlisting}

\myself{Something to say?}
\me{No.}
\myself{Good.}

\subsection{Polyphonic sections}
\label{sec:TutoPolyphonic}

A polyphonic section is a set of sheets with the same duration and played at the same time. To create a polyphonic sheet, the \emph{monophonic} sheets have to be combined with the operator \lstinline!mrdivide! (\lstinline!/!). \\
\begin{lilypond}
\new GrandStaff <<
	\new Staff { \time 3/4 \relative c'' <<
		{ c2. <c, e g c>2. } \\
		{ c4( e g) s2. }
		>> }
	\new Staff { \clef bass \relative c { c2.( c) } }
>>
\end{lilypond}
\begin{lstlisting}
NoteInit
sheet = [ ( +C:N2' ) / ~[ C:N4 E:N4 G:N4 ] bar ...
	[ C E G +C ]:N2' bar ] / ...
	[ -C:N2' bar ~-C:N2' bar ];
\end{lstlisting}

\begin{meenv}%
It's too bad: there are no polyphonic section in \frerejaques.%
\end{meenv}
\begin{myselfenv}%
Yes, but it's nice in a canon:

\begin{lstlisting}
>> NoteInit
>> sheet = [ ...
	G:N4 A:N4 bar ...
	B:N4 G:N4 bar ...
	B:N4 +C:N4 bar ...
	+D:N2 bar ...
	+D:N8' +E:N16 +D:N8 +C:N8 bar ...
	B:N4 G:N4 bar ...
	G:N4 D:N4 bar ...
	G:N2 bar ];
>> delay = [ N2 bar N2 bar ];
>> cacofonix( 'FrereJacques', 'Tempo', 100, ...
	[ sheet delay ] / [ delay sheet ] );
\end{lstlisting}%
\end{myselfenv}

\subsection{Display}

A good way to check errors is to display the sheet: the function \lstinline!display! has been overloaded to represent the sheet. This is the display of \frerejaques:
\begin{lstlisting}
>> NoteInit
>> sheet = [ ...
	G:N4 A:N4 bar ...
	B:N4 G:N4 bar ...
	B:N4 +C:N4 bar ...
	+D:N2 bar ...
	+D:N8' +E:N16 +D:N8 +C:N8 bar ...
	B:N4 G:N4 bar ...
	G:N4 D:N4 bar ...
	G:N2 bar ];
>> sheet
$1///////////////////////////////////////////////$
$|-----------G-----------|-----------A-----------$
$2///////////////////////////////////////////////$
$|-----------B-----------|-----------G-----------$
$3///////////////////////////////////////////////$
$|-----------B-----------|-----------C-----------$
$4///////////////////////////////////////////////$
$|-----------------------D-----------------------$
$5///////////////////////////////////////////////$
$|--------D--------|--E--|-----D-----|-----C-----$
$6///////////////////////////////////////////////$
$|-----------B-----------|-----------G-----------$
$7///////////////////////////////////////////////$
$|-----------G-----------|-----------D-----------$
$8///////////////////////////////////////////////$
$|-----------------------G-----------------------$
\end{lstlisting}

New lines are set according to bars, and a lot of stuff can be displayed: chords, polyphonic sheet, meters, markers, dynamics, tempo\dots Only note's octave is never displayed.

To set the number of characters per quater note, you have to use the class function \lstinline!setNbCharByQuater! (\eg: \lstinline!Note.setNbCharByQuater(48)! --- the default value is 24).

\subsection{A little more about the \lstinline!cacofonix! function}

As you know, the \lstinline!cacofonix! function writes the final file. It is possible to give several sheets: to do that, you have to precise the wanted instrument before the sheet. Suppose you have two sheets, \lstinline!sheet_violin! and \lstinline!sheet_trumpet!:
\begin{lstlisting}
cacofonix( 'myFile.mid', 'Tempo', 100, ...
	'Violin', sheet_violin, ...
	'Trumpet', sheet_trumpet )
\end{lstlisting}

To know the list of available instruments, type \lstinline!cacofonix -instruments!. You can't play more than fifteen instruments, but with possibilities to set several sheets for one instrument.

Some percussions are available too, type \lstinline!cacofonix -percussions! to know the list. However, percussion sheets can't have tonality: instead of using tonality notes (\lstinline!Note('G')!), you have to use the void note: \lstinline!V=Note('void')!. There are no restriction about the number of percussion sheet.

\subsection{And now?}

Well, we have a nice version of \frerejaques:
\begin{lstlisting}
NoteInit
sheet = [ ...
	G:N4 A:N4 bar ...
	B:N4 G:N4 bar ...
	B:N4 +C:N4 bar ...
	+D:N2 bar ...
	+D:N8' +E:N16 +D:N8 +C:N8 bar ...
	B:N4 G:N4 bar ...
	G:N4 D:N4 bar ...
	G:N2 bar ];
cacofonix( 'FrereJacques', 'Tempo', 100, sheet );
\end{lstlisting}

\me{Hurray!}

We have seen in this tutorial only very basic features of \cacofonix, but it's probably enough for start.

The script \file{ForElise.m} is a good demonstration of the possibilities of \cacofonix: you can see different attacks, markers, dynamics, tempo, sustain\dots The next section will explain more precisely all the features of \cacofonix.

Thank you to have read this document, and for your interest about \cacofonix.

\myself{Enjoy!}

\section{Reference guide}

\subsection{Overview}

In this reference guide, we will see every possibilities to transcribe any sheet the most quickly and faithfully as far as it can be. We suggest to have read the tutorial before start the next sections.

The first introductive sections will be about important and general key concepts of \cacofonix. From section \ref{sec:Tonalities}, we will see the \emph{advanced usages of the basic features}. Then, from the section \ref{sec:Transpose}, we will gently study the \emph{insane usages of the super weird features}. Finally, we will finish with the API\footnote{\emph{Application Programming Interface}, of course\dots} of the \lstinline!cacofonix! function.

\me{I feel it will be \dots BOOOOOOOORING!}
\myself{Well, your analysis is short and simplistic, but correct. The point is: if you want to play \emph{Three Blind Mice}, you have everything you need in the tutorial. If you want to play the Schubert's \emph{Trout Quintet}, you should read carefully this guide.}

To search of a particular point, three tables can help: all features concerning a special use of the \note constructor are in table \ref{tab:NoteAPI}, member functions and operators are listed in the table \ref{tab:NoteFunctions} and the \lstinline!cacofonix! function API is on the table \ref{tab:CacofonixAPI}.

\begin{table}
	\centering
	\begin{tabular}{llcl}
		Contructor syntax & Description & Scope & Section \\
		\hline
		\lstinline!Note( tonality )! & tonality & N & \ref{sec:Tonalities} \\
		\lstinline!Note( duration )! & duration & N & \ref{sec:Duration} \\
		\lstinline!Note( 'bar' )! & bars & M & \ref{sec:MetersAndBars} \\
		\lstinline!Note( [upper lower] )! & meters & G & \ref{sec:MetersAndBars} \\
		\lstinline!Note( '+X'|'-X' )! & octave & M & \ref{sec:OctaveNote} \\
		\lstinline!Note( 'dynamics', dyn, [ d ] )! & dynamics & M & \ref{sec:Dynamics} \\
		\lstinline!Note( 'dynamics*', dyn, [ d ] )! & channel dynamics & C & \ref{sec:ChannelDynamics} \\
		\lstinline!Note( 'cresc', dur, dyn, [ d ] )! & crescendo & M & \ref{sec:Crescendo} \\
		\lstinline!Note( 'cresc*', dur, dyn, [ d ] )! & channel crescendo & C & \ref{sec:ChannelDynamics} \\
		\lstinline!Note( 'tempo', tempo )! & tempo & G & \ref{sec:Tempo} \\
		\lstinline!Note( 'accel', dur, tempo )! & accelerando & G & \ref{sec:AccelerandoRallentando} \\
		\lstinline!Note( 'fermata', dur, play )! & fermata & G & \ref{sec:Fermata} \\
		\lstinline!Note( 'sustain', 'on'|'off' )! & sustain & C & \ref{sec:Sustain} \\
		\lstinline!Note( 'marker', mark )! & marker & G & \ref{sec:Markers} \\
		\lstinline!Note( 'marker*', mark )! & go to & M & \ref{sec:Goto} \\
		\lstinline!Note( 'pitch', [ t ], val, [ d ] )! & pitch wheel & C & \ref{sec:Pitch} \\
		\lstinline!Note( 'void' )! & void note & N & \ref{sec:VoidNote} \\
	\end{tabular}
	\caption[\note constructor API]{\note constructor API. Scope column: N means note, M means monophonic, C means channel and G means global.}
	\label{tab:NoteAPI}
\end{table}

\begin{table}
	\centering
	\begin{tabular}{lllcl}
		Member function & Operator & Description & Scope & Section \\
		\hline
		\lstinline!plus! & \lstinline!+! & chord & N & \ref{sec:Chord} \\
		\lstinline!colon! & \lstinline!:! & set duration & N & \ref{sec:SetDuration} \\
		\lstinline!ctranspose! & \lstinline!'! & dot & N & \ref{sec:DottedNotes} \\
		\lstinline!not! & \lstinline!~! & tie & N & \ref{sec:TiesAndSlurs} \\
		\lstinline!uplus!, \lstinline!uminus! & \lstinline!+!, \lstinline!-! & octave & N & \ref{sec:OctaveOperators} \\
		\lstinline!mrdivide! & \lstinline!/! & polyphonic section & N & \ref{sec:Polyphony} \\
		\lstinline!mpower! & \lstinline!^! & transposition & N & \ref{sec:Transpose} \\
		\lstinline!mtimes! & \lstinline!.*! & riff & N & \ref{sec:RepeatRiff} \\
		\lstinline!or! & \lstinline!|! & extraction & C & \ref{sec:Extraction} \\
		\lstinline!display!& & display & C & \ref{sec:Display} \\
		\lstinline!times! & \lstinline!*! & expand & N & \ref{sec:Expand} \\
		\lstinline!minus! & \lstinline!-! & index & N & \ref{sec:Index} \\
	\end{tabular}
	\caption[\note member functions]{\note member functions. Scope column: N means note, M means monophonic, C means channel and G means global.}
	\label{tab:NoteFunctions}
\end{table}

\begin{table}
	\centering
	\begin{tabular}{llcl}
		\lstinline!cacofonix! function syntax & Description & Scope & Section \\
		\hline
		\lstinline!cacofonix( file, ... )! & output file & & \ref{sec:CacofonixFunction} \\
		\lstinline!cacofonix( ..., instrument, sheet, ... )! & add sheets & C & \ref{sec:CacofonixFunction} \\
		\lstinline!cacofonix( ..., mainSheet, ... )! & main sheet & G & \ref{sec:MainSheet} \\
		\lstinline!cacofonix( ..., 'Tempo', tempo, ... )! & default tempo & G & \ref{sec:Tempo} \\
		\lstinline!cacofonix( ..., 'Velocity', velocity, ... )! & velocity & G & \ref{sec:Velocity} \\
		\lstinline!cacofonix( ..., 'DrumKit', drumkit, ... )! & drum kit & G & \ref{sec:CacofonixFunction} \\
	\end{tabular}
	\caption[\lstinline!cacofonix! function API]{\lstinline!cacofonix! function API. Scope column: N means note, M means monophonic, C means channel and G means global.}
	\label{tab:CacofonixAPI}
\end{table}

\subsection{Sheets, instruments, tracks and channels}

For \cacofonix, the transcription of a sheet is realized with an array of \note objects. In all this document, we call a sheet a coherent array of \note for \cacofonix.

In the midi files, a track is a list of events: play that note, play stronger, use the pitch wheel\dots In fact, a track is the midi side of a sheet: \cacofonix writes each sheet in a track, and a track contains only one sheet. The number of tracks is not limited.

A channel is another midi concept: each channel has, among other things, an instrument timbre, a volume and is controlled by one or several tracks. It's a kind of out of one instrument, but all percussions are regrouped in one (and only one) channel. Midi specifications allow only sixteen channels: fifteen for regular instruments and one for percussions.

Last rule of the game: \cacofonix doesn't allow to modify the instrument in a sheet.

\paragraph{}

So.

\paragraph{}

\emph{One} sheet is written for \emph{one} instrument. It's still true for a drum set: each element of the drum set (bass drum, toms, hi-hat, cymbals\dots) and more generally each percussion have to has it's own sheet, with void notes (see \ref{sec:VoidNote}) instead of tonality notes.

The reciprocal is not true: \emph{one} instrument can have \emph{several} sheets. Either each sheet has its own track, or sheets are merged in the same track with the operator \lstinline!mrdivide! (\lstinline!/!). The two solutions produce exactly the same audible result. The section \ref{sec:CacofonixFunction} describes how create a channel and link it with tracks (in other words: how associate an instrument with sheets).

\subsection{The scope}
\label{sec:scope}

For each features of \cacofonix, there is four possible scopes: note, monophonic, channel or global.
\begin{itemize}
	\item A feature with a note scope will modify only one note (or sometimes, an array of notes), and the next notes are not influenced.
	\item A feature with a monophonic scope is a little more complicated. This kind of features modify the next notes of the monophonic part\footnote{It's a sad misuse of language: a polyphonic section is said composed of \emph{monophonic} parts, even if a monophonic part can contains polyphonic sections itself.}. If the feature is placed in a monophonic section, the other monophonic parts (which are played in parallel) are not modified, influenced or perturbed, in any way. If, in the monophonic part and after the modification, a new polyphonic section starts, the feature will be apply in every new monophonic parts. Last point: after the polyphonic section, the last modification of the last written monophonic part will be active. This is a good example (see section \ref{sec:PlainDynamics} for explications about dynamics):
\begin{lstlisting}
NoteInit
sheet = [ C:N bar ...      % dyn: mf (default)
	DynF D:N bar ...       % dyn: f  (setted)
	[ ...                  % start a mono. section
		E:N bar ...        % dyn: f
		DynMP F:N bar ...  % dyn: mp (setted)
		G:N bar ...        % dyn: mp (not modified)
		A:N bar ...        % dyn: mp (not modified)
	] ...                  % end of the mono. section
	/ ...                  % polyphony
	[ ...                  % new mono. section
		+E:N bar ...       % dyn: f
		+F:N bar ...       % dyn: f  (not modified)
		DynPP +G:N bar ... % dyn: pp (setted)
		+A:N bar ...
	] ...                  % end of the poly. section
	+C:N bar ...           % dyn: pp
	];
\end{lstlisting}
	\item A feature with a channel scope modify\dots the channel, and so all played sheets of the modified instrument at the same time. Be careful: remember that percussions share the same channel!
	\item Finally, a feature with a global scope modify all sheets given to the \lstinline!cacofonix! function. For more readability, theses features can be grouped in a main sheet, see the section \ref{sec:MainSheet}.
\end{itemize}

\me{I not sure to understand\dots}
\myself{A feature with a note scope modify a note. When it's a monophonic scope, that modify the monophonic section. A channel scope modify the channel, and a global feature modify all sheets. It's almost logical.}
\me{Yes, but the monophonic scope seems tricky.}
\myself{Don't be stressed out. There are more difficult to understand latter.}

\subsection{Tonalities}
\label{sec:Tonalities}

To create a tonality \note object, you simply have to call the constructor with a string containing the name of the expected note. The basic names are \lstinline!'rest'! for a rest, \lstinline!'void'! for a void note (see section \ref{sec:VoidNote}), \lstinline!'do'!, \lstinline!'re'!, \lstinline!'mi'!, \lstinline!'fa'!, \lstinline!'sol'!, \lstinline!'la'!, \lstinline!'si'! and \lstinline!'a'!, \lstinline!'b'!, \lstinline!'c'!, \lstinline!'d'!, \lstinline!'e'!, \lstinline!'f'! and \lstinline!'g'!. You can add one or two \lstinline!'b'! (\emph{b\'emol}, flat) or \lstinline!'d'! (\emph{di\`ese}, sharp) after \lstinline!'do'!, \lstinline!'re'!, \lstinline!'mi'!\dots and you can add one or two \lstinline!'f'! or \lstinline!'s'! after \lstinline!'a'!, \lstinline!'b'!, \lstinline!'c'!\dots The constructor is case insensitive.

In \noteInitFile and \noteInitFrFile files, only notes with none or one accident are instanced, but something like \lstinline!Eff = Note( 'Eff' );! is completely valid.

\subsection{Duration}
\label{sec:Duration}

To create a duration \note object, you have to call the constructor with a double, which will be the duration of the note, in number of beats: \lstinline!Note(4)! for a whole note, \lstinline!Note(1)! for a quarter note. Per default, a duration note which has not been associated with a tonality note is a rest.

\noteInitFile and \noteInitFrFile define some useful duration: the whole note to the sixteenth note and the triplet quarter note.

\subsection{Chord \lstinline!+!}
\label{sec:Chord}

In the tutorial, the binary operator \lstinline!plus! (\lstinline!+!) is used to create chords, but this operator is more general. It merge two notes (or two array of notes) in one object: tonalities are recorded as a chord and durations are summed.

\myself{The script can become messy very quickly if this operator is not correctly used.}
\me{Yes, there is a lot of possibilities: \lstinline!C+N2+E+N8+G!, or \lstinline![C N2]+[E N8]+G!, or \lstinline!C+[N2 E+[N8 G]]!\dots It's awesome.}
\myself{Every time you don't use that operator correctly and neatly, you make Jesus cry and God kills a kitten.}%, and you will burn in hell to expiate your felony.}

The final note is tied, detached or arpeggiated if in the two arrays, at least on note is tied, detached or arpeggiated. See the section \ref{sec:TiesAndSlurs} for more informations about ties and detached notes and the section \ref{sec:SetDuration} for arpeggios.

% \me{Arpeggios? Arpeggi?}
% \myself{\wikipedia gives both\footurl{http://en.wikipedia.org/wiki/Arpeggio}, \wiktionary gives only arpeggios\footurl{http://en.wiktionary.org/wiki/arpeggio}. \google finds 3 820 000 results for argeggios and only 634 000 for arpeggi. The \textsc{Oxford Dictionaries} and The \textsc{Cambridge Dictionaries Online} suggest only arpeggios\footurl{http://oxforddictionaries.com/definition/arpeggio}\footurl{http://dictionary.cambridge.org/dictionary/british/arpeggio}. Arpeggios win.}

\subsection{Octave}
\label{sec:Octave}

There are two ways to add or subtract an octave to a note: the unary operators \lstinline!+! and \lstinline!-! and a special note.

\subsubsection{Octave (operators \lstinline!+! and \lstinline!-!)}
\label{sec:OctaveOperators}

The simplest way to modify the octave of a note is the unary operators \lstinline!+! and \lstinline!-!. Some examples: \\
\begin{lilypond}
\relative c' { \new Staff { \time 4/4 g2 c e g a b c c' <e,,, g c c''>1 } }
\end{lilypond}

\begin{lstlisting}
NoteInit
sheet = [ ...
	-G:N2 C:N2 bar ...
	E:N2 G:N2 bar ...
	A:N2 B:N2 bar ...
	+C:N2 ++C:N2 bar ...
	-E+-G+C+++C:N bar ];
\end{lstlisting}

\begin{meenv}%
The operators \lstinline!+! and \lstinline!-! can be used on array. So, instead of:
\begin{lstlisting}
sheet = [ +C:N bar +E:N bar +G:N bar ];
\end{lstlisting}
we can write:
\begin{lstlisting}
sheet = +[ C:N bar E:N bar G:N bar ];
\end{lstlisting}%
\end{meenv}
\myself{Yes, but maybe the special note for the octave is more convenient.}

\subsubsection{Octave (note)}
\label{sec:OctaveNote}

Sometimes, a sheet or a section of a sheet is naturally high or low pitched. So, instead of add \lstinline!+! or \lstinline!-! behind each note
\myself{\dots or use it on an array like a tramp \dots} \\
\dots you can add a special note which means the default octave. To create a note which raises of $n$ octaves, you have to call the constructor \note with a string \lstinline!'+n'! (\eg, \lstinline!Note('+2')! to raise of two octaves). Use a string \lstinline!'-n'! to lower of $n$ octaves. To restore the default octave, you can use \lstinline!Note('+0')! or \lstinline!Note('-0')!. \\
\begin{lilypond}
\relative c' { \new Staff { \time 4/4 g4 a d f, g a d f, g'' f a g g, f a g } }
\end{lilypond}

\begin{lstlisting}
NoteInit
sheet = [ ...
	          -G:N4 -A:N4  D:N4 -F:N4 bar ...
	Note('-1') G:N4  A:N4 +D:N4  F:N4 bar ...
	Note('+1') G:N4 F:N4 A:N4 G:N4 bar ...
	Note('+0') G:N4 F:N4 A:N4 G:N4 bar ];
\end{lstlisting}

\myself{I guess you would talk about the other way to create this kind of \note?}
\me{Yeah. Instead of using a \lstinline!'+n'! form, you can create a string repeating \lstinline!'+'! $n$ times, like that: \lstinline!Note('+++')! instead of \lstinline!Note('+3')!. Of course, it's also working with \lstinline!'-'!, and it's working even if $n$ means $0$: \lstinline!Note('')! is equivalent at \lstinline!Note('+0')!!}

\subsection{Set duration \lstinline!:!}
\label{sec:SetDuration}

Officially, the operator \lstinline!colon! (\lstinline!:!) associates a tonality note (or an array of tonality notes) with a duration note (or an array of duration notes):
\begin{lstlisting}
>> mynote = tonality:duration;
\end{lstlisting}

In fact, the operator \lstinline!:! is like the operator \lstinline!+!: it merges two array of notes in the same way. The difference is the optional argument, a string which is composed with the characters of the table \ref{table:charsOfColon}: only one accent can be specify (\lstinline!'>'!, \lstinline!'.'!, \lstinline!'^'! or \lstinline!'-'!), the characters \lstinline!'|'!, for a detached note, and \lstinline!'$'!, for an arpeggiated chord, can be added after or before (for more information about detached notes, see the section \ref{sec:TiesAndSlurs}). If the note is tied (and not detached), the arpeggio is ignored.

\begin{table}
	\center
\begin{tabular}{ccp{7cm}}
\lstinline!'>'! & accent & raise the dynamics of the note \\
\lstinline!'.'! & staccato & the note is played only during the half of its duration \\
\lstinline!'^'! & marcato & like an accent and a staccato \\
\lstinline!'-'! & tenuto & like an accent and the delay between the previous note and this one is risen \\
\lstinline!'|'! & detached & the note is detached, even if it is tied \\
\lstinline!'$'! & arpeggio & the chord is arpeggiated. \\
\end{tabular}
\caption{Characters composing the optional string of the operator \lstinline!:!}
\label{table:charsOfColon}
\end{table}

Some examples: \\
\begin{lilypond}
	\new Staff { \time 4/4 \relative c'' { c4\accent b\staccato a\marcato g\tenuto c,4\( ^( c8) g'8 g2\accent \) } }
\end{lilypond}

\begin{lstlisting}
NoteInit
sheet = [ ...
	+C:'>':N4 B:'.':N4 A:'^':N4 G:'-':N4 bar ...
	~[ C:N4 C:N8 G:N8 G:'|>':N2 ] bar ];
\end{lstlisting}

\subsection{Dotted notes \lstinline!'!}
\label{sec:DottedNotes}

The operator \lstinline!ctranspose! (\lstinline!'!) raises the duration of the note, as a dot: one \lstinline!'! increases the duration of the note by half of its original value, $n$ \lstinline!'! serve to lengthen the note by $1 - \frac{1}{2^n}$ of its original duration. For example: \\
\begin{lilypond}
	\relative c'' { \new Staff { \time 2/4 g4. g8 g8. g16 g8. g16 g4.. g16 } }
\end{lilypond}

\begin{lstlisting}
NoteInit

sheet = [ ...
	G:N4' G:N8 bar ...
	G:N8' G:N16 G:N8' G:N16 bar ...
	G:N4'' G:N16 bar ];
\end{lstlisting}

\me{It's exactly the same example as the section \ref{sec:TutoDottedNotes}!}
\myself{Yes, but it's not the same explanation. And it's a good example.}

\subsection{Ties and slurs \lstinline!\~!}
\label{sec:TiesAndSlurs}

The operator \lstinline!not! (\lstinline!~!) is used to defined ties and slurs. Technically, the note preceding a tied note is played for all its duration, and the notes are merged if they have the same tonality. Sometimes, during a slur, two notes with the same tonality can be juxtaposed: \cacofonix will merge them, unless if the second note precise an attack with the \lstinline!'|'! character (the note is \emph{detached}).

If the operator \lstinline!not! is applied on an array of \note, all \note objects in the array will be tied. In this case, the array can contain not playable \note objects (like bars, meters, crescendo\dots): the operator will ignore them. This is some examples: \\
\begin{lilypond}
	\relative c'' { \new Staff { \time 4/4 g4( g) f( a) g( g) f( a) g\( ^( g) f a \) g\( g f a g1 \) } }
\end{lilypond}

\begin{lstlisting}
NoteInit
sheet = [ ...
	G:N4 ~G:N4 F:N4 ~A:N4 bar ...
	~[ G:N4 G:N4 ] ~[ F:N4 A:N4 ] bar ...
	G:N4 ~G:N4 ~F:N4 ~A:N4 bar ...
	~[ G:N4 G:'|':N4 F:N4 A:N4 bar ...
	G:N ] bar ];
\end{lstlisting}

\begin{meenv}%
The operator \lstinline!~! has an other very specific application: it changes a \emph{marker} to a \emph{goto marker}. See the section \ref{sec:Goto} for more details.%
\end{meenv}

\subsection{Meters and bars}
\label{sec:MetersAndBars}

To defined a meter, you have to instantiate a special \note object by calling the constructor \note with an array of two double \lstinline!meter = Note([upper lower])!. Without surprise, the double \lstinline!upper! indicates how many beats there are in a measure and the double \lstinline!lower! indicates the note value which represents one beat.

\lstinline!Note('bar')! creates an object representing a bar, and you use it every time you have to separate two measures. You can add bars in tied arrays, in repeated sections (right or left side, see \ref{sec:RepeatRiff}), or in expandable sections (only left side, see \ref{sec:Expand}).

When several sheets are given to \cacofonix, the first sheet defined the meters. Next sheets have to precise bars, but not meters (meters are in the global scope, although bars are only in the monophonic scope). If another sheet specify meters, the meters can't be different from the first sheet. With the same spirit, in polyphonic sections, bars have to be added everywhere and, if the meters have to be defined, the first monophonic section contains meters objects and the others don't have to, but if they do, meters have to be always identical.
%\me{For project with several sheets, it's maybe a good idea if the first sheet is only composed with meters, and maybe the other things whith a global scope like tempo and markers, do you think?}
%\myself{Shh! It's explained at the section \ref{sec:MainSheet}. Let him talk.}

The first measure duration is never checked, to allow anacrusis. If no meter is given, the second measure is the reference and all measure have to have the same duration. Even if the first measure is an anacrusis, the other measures have to always have the same duration, or the meter has to be redefined.

\begin{lilypond}
\new GrandStaff <<
\new Staff { \clef treble \relative c' { \time 6/8 \partial 4 r8 <g e'> <c e g>8 <c e g> <c e g> <e g c> <e g c> <e g c> \time 3/4 <c f a>4 <a c f> <f a c> \time 6/8 <c' e g>8 <c e g> <c e g> <e g c> <e g c> <e g c> \time 3/4 <g b d>4 <d g b> <b d g> } }
\new Staff { \clef bass \relative c, { c8 r c r r g r r c g' g, g' c, g' c, r r g r r c g' g, g' c, g' } } >>
\end{lilypond}

\begin{lstlisting}
NoteInit
meter68 = Note( [6 8] );
meter34 = Note( [3 4] );

longmeasure = [ ...
	C+E+G:N8 C+E+G:N8 C+E+G:N8 ...
	E+G++C:N8 E+G++C:N8 E+G++C:N8 ];

sheet = [ meter68 R:N8 -G+E:N8 bar ...
	longmeasure bar ...
	meter34 C+F+A:N4 -A+C+F:N4 -F+-A+C:N4 bar ...
	meter68 longmeasure bar ...
	meter34 G+B++D:N4 D+G+B:N4 -B+D+G:N4 bar ...
	] / [ ...
	Note('--') C:N8 R:N8 bar ...
	C:N8 R:N8 R:N8 -G:N8 R:N8 R:N8 bar ...
	C:N8 G:N8 -G:N8 G:N8 C:N8 G:N8 bar ...
	C:N8 R:N8 R:N8 -G:N8 R:N8 R:N8 bar ...
	C:N8 G:N8 -G:N8 G:N8 C:N8 G:N8 bar ];
	

cacofonix( 'America', 'Tempo', 140, sheet );
\end{lstlisting}

\me{You don't have to use meters and bars.}
\myself{Here we go\dots}
\me{It's true: any midi files \cacofonix can produce, you can make the same results with or without.}
\begin{myselfenv}%
	OK, yes, you're right. Adding bars is boring: you spend time for something which don't appear in the final midi file. But, sometimes, you have thinking about something else, and you have get the wrong duration on several notes. Then, you spend \emph{a lot} of time to find where is the mistake on the sheet, correct the code, re-launch \cacofonix and replay the midi files until the next error. Well, with bars, you can still get the wrong tonality of course, but get the wrong duration makes nicely crash \cacofonix, and the error message gives you what is the problematic measure. Look at that:
\begin{lstlisting}
>> NoteInit
>> cacofonix('dumass', [ Note([4 4]) C:N4 bar E:N4 bar G:N bar ])
??? Error using ==> cacofonix
The measure 2 of the sheet 1 is incorrect.
\end{lstlisting}%
\end{myselfenv}
\me{Humpf.}

\subsection{Dynamics}
\label{sec:Dynamics}

Dynamics are really important: they add all the expressiveness.
\me{\dots as far as midi files can be played with expressiveness.}

\subsubsection{Plain dynamics}
\label{sec:PlainDynamics}

\begin{table}
	\centering
	\begin{tabular}{rll}
		\lstinline!'inf'! & & loudest possible \\
		\lstinline!'fff'! & forteissimo possibile & very \emph{very} loud \\
		\lstinline!'ff'! & fortissimo & very loud \\
		\lstinline!'f'! & forte & loud \\
		\lstinline!'mf'! & mezzo-forte & moderately loud (default) \\
		\lstinline!'mp'! & mezzo-piano & moderately soft \\
		\lstinline!'p'! & piano & soft \\
		\lstinline!'pp'! & pianissimo & very soft \\
		\lstinline!'ppp'! & pianissimo possibile & softest possible \\
		\lstinline!'0'! & & silence \\
	\end{tabular}
	\caption{Strings for dynamics}
	\label{tab:dynamics}
\end{table}

To start a section with a precise dynamic, you just have to add a special note: \lstinline!Note('dynamics',dyn)!, where \lstinline!dyn! is a string found in the table \ref{tab:dynamics}. You can also create a dynamic note with a delay: \lstinline!Note('dynamics',dyn,delay)!. The delay is a double or a duration \note and the new dynamic will be effective only after this duration.

\myself{Two precisions: this kind of dynamics specify only how notes are attacked. Even with the delay parameter, you can't modify the dynamic of a note which has begun to be played. So, you can't play fun dynamics like \sfz.}
\me{\dots yet. The trick is at the section \ref{sec:ChannelDynamics}.}
\myself{The second point is about polyphony: plain dynamics have a monophonic scope, so every monophonic part can have a different current dynamic. It's very useful: in a sheet for piano, the right hand and the left hand can play differently.}
\me{But don't forget to specify changes everywhere!}

Plain dynamics, from \lstinline!'fff'! to \lstinline!'ppp'! are defined in \lstinline!NoteInit! and \lstinline!NoteInit_fr! scripts, in the variables \lstinline!DynFFF! to \lstinline!DynPPP!.

\subsubsection{Crescendo}
\label{sec:Crescendo}

To play a crescendo, you have to add a note created by \lstinline!Note( keyword, duration, dynamics )! or \lstinline!Note( keyword, duration, dynamics, delay )!:
\begin{itemize}
	\item \lstinline!keyword! can be \lstinline!'crescendo'!, \lstinline!'cresc'!, \lstinline!'decrescendo'! or \lstinline!'decresc'!.
		\me{Fun story: you can use indifferently these key words!}% \lstinline!'crescendo'! and \lstinline!'cresc'! can be used to create a decrescendo, and \lstinline!'decrescendo'! and \lstinline!'decresc'! can be used for a crescendo.}
	\item \lstinline!duration! can be a double or a duration \note which indicates the duration of the crescendo (or the decrescendo).
	\item \lstinline!dynamics! is a string from the table \ref{tab:dynamics}: it gives the final dynamic.
	\item \lstinline!delay! is an optional double or a duration \note. Like for the dynamic \note, the crescendo starts only after this duration (and ends at \lstinline!delay+duration!).
\end{itemize}

Like plain dynamics, \cacofonix looks at the current dynamic at the start of the note, and apply this dynamic only for the attack of the note. So you can't play crescendo or decrescendo on one note.

\subsubsection{The velocity}
\label{sec:Velocity}

To each dynamic corresponds a velocity: it's a value between $0$ and $127$ which specify the attack of the note, in the midi file. You can redefine the mapping: when you're calling the \cacofonix function, add two more parameters:
\begin{lstlisting}
cacofonix( filename, ..., 'Velocity', velocities, ... )
\end{lstlisting}
where \lstinline!velocities! is an array of $8$ values which gives the velocity values of dynamics \lstinline!'ppp'! to \lstinline!'fff'!. You can't set the velocity of the dynamic \lstinline!'0'! and \lstinline!'inf'!, which are always $0$ and $127$. The default values are $16$, $33$, $49$, $64$, $80$, $96$, $112$ and $126$.

\subsubsection{Channel dynamics}
\label{sec:ChannelDynamics}

When you create a \note object with \lstinline!'dynamics'!, \lstinline!'crescendo'!, \lstinline!'cresc'!, \lstinline!'decrescendo'! or \lstinline!'decresc'!, you specify only the attacks of next notes. But there is an other way to modify the dynamics: when you add \lstinline!*! at the end of these keywords (\eg \lstinline!'cresc*'!), you modify the volume of the instrument (or the volume of the \emph{channel}). It's pretty convenient for modify the dynamic of notes after the attack, but never forget that, in polyphonic sections, all monophonic sections will be influenced, as the other sheets associate to the same instrument, and it's only modify the volume, whereas a plain dynamic (without \lstinline!*!) is more realistic and can modify the volume and the timbre of the instrument.

Plain dynamics and channel dynamics are independent: even if the current plain dynamic is set, the current channel dynamic is not modify. Also, you can boost a plain dynamic with a channel dynamic, but the experience shown that mix the two kinds of dynamics is quickly messy and it's often a bad idea.

\subsubsection{Example}

This is a famous example using dynamics: \\
\begin{lilypond}
\new Staff { \key d \major \time 4/4 \relative c'' { fis2->\ff b,8\mp\< cis d e fis4.->\ff d8 fis4.-> d8 fis4.-> b,8 d b g d' \dim b1\! } }
\end{lilypond}

\begin{lstlisting}
NoteInit
sheet = [ Note([4 4]) Note('+') DynFF ...
	Fs:'>':N2 ...
	DynMP Note('cresc', N2, 'FF' ) ...
	-B:N8 Cs:N8 D:N8 E:N8 bar ...
	Fs:'>':N4' D:N8 Fs:'>':N4' D:N8 bar ...
	Fs:'>':N4' DynMF ...
	Note('dynamics*', 'FF' ) ...
	-B:N8 D:N8 -B:N8 -G:N8 D:N8 bar ...
	Note('decresc*', N, '0' ) -B:N bar ];

cacofonix( 'SwanLake', 'Tempo', 80, 'Flute', sheet );
\end{lstlisting}

Look at the switch plain/channel dynamic: the plain dynamic is reset (line 7) and the channel dynamics takes the old value of the plain (line 8).

\subsection{Tempo}
\label{sec:Tempo}

Two ways to set the tempo:
\begin{itemize}
	\item the tempo is constant: in this case, you can just add two input parameters at the calling of the \cacofonix function:
\begin{lstlisting}
cacofonix( filename, ..., 'Tempo', tempo, ... )
\end{lstlisting}
	\item the tempo is not constant: to set a new tempo, add in the sheet a note created with \lstinline!Note('tempo',tempo)!.
\end{itemize}

The tempo is independent of the meters: the double \lstinline!tempo! is always the number of quarter notes (\lstinline!Note(1)!) per minutes.

All sheets share the same tempo in the same time (tempo has a global scope), so you should set the tempo only in one sheet.

\subsubsection{Accelerando/Rallentando}
\label{sec:AccelerandoRallentando}

You can set a new tempo progressively with \lstinline!Note( keyword, duration, newTempo )!, where \lstinline!keyword! is \lstinline!'accelerando'!, \lstinline!'rallentendo'!, \lstinline!'accel.'!, \lstinline!'rall.'!, \lstinline!'accel'! or \lstinline!'rall'!, \lstinline!duration! is the transition duration (a double or a duration \note), and \lstinline!newTempo! is the final tempo, reached after the given duration.

\subsubsection{Fermata}
\label{sec:Fermata}

You can indicate a fermata with \lstinline!Note( 'fermata', duration, playedDuration )!: \lstinline!duration! is the duration of the fermata (on the sheet) and \lstinline!playedDuration! is wanted duration of the fermata with the current tempo. \lstinline!duration! and \lstinline!playedDuration! can be doubles or duration \note objects.

\myself{Generally, the \lstinline!playedDuration! is twice bigger than \lstinline!duration!.}
\me{So, why the \lstinline!playedDuration! is not optional with a default value setted to twice \lstinline!duration!?}
\myself{Because I'm lazy. But it's on the todo list.}

\subsubsection{Example}

This is an example of the tempo features: \\
\begin{lilypond}
\new Staff { \tempo 4=80 \clef bass \key g \major \time 4/4 \relative c {
g''16 b, d, b' g' b, g' b, g' b, d, b' g' b, g' b, 
g' a, d, a' g' a, g' a, g' a, d, a' g' a, g' a,
fis' c d, c'_\markup{ \italic rall... } ~ fis c fis c fis c d, c' fis c fis c
<g, b' g'>1\fermata } }
\end{lilypond}

\begin{lstlisting}
NoteInit
sheet = [ Note('-') Note('Tempo', 80) ...
	+G:N16 B:N16 D:N16 B:N16 ...
		+G:N16 B:N16 +G:N16 B:N16 ...
		+G:N16 B:N16 D:N16 B:N16 ...
		+G:N16 B:N16 +G:N16 B:N16 bar ...
	+G:N16 A:N16 D:N16 A:N16 ...
		+G:N16 A:N16 +G:N16 A:N16 ...
		+G:N16 A:N16 D:N16 A:N16 ...
		+G:N16 A:N16 +G:N16 A:N16 bar ...
	+Fs:N16 +C:N16 D:N16 +C:N16 ...
		Note( 'rall', N2', 60 ) ...
		+Fs:N16 +C:N16 +Fs:N16 +C:N16 ...
		+Fs:N16 +C:N16 D:N16 +C:N16 ...
		+Fs:N16 +C:N16 +Fs:N16 +C:N16 bar ...
	Note( 'fermata', N, N') -G+B++G:N bar ];

cacofonix( 'CelloSuite_Prelude', 'Cello', sheet );
\end{lstlisting}

\subsection{Polyphony \lstinline!/!}
\label{sec:Polyphony}

Polyphonic sections are really useful, in particular in the case where your instrument has the possibility to play several notes independently, like a piano with the right and left hands.

Polyphonic sections are easy to use: just merge two sheets with the operator \lstinline!mrdivide! (\lstinline!/!). The two sheets are called \emph{monophonic sections}, even if they contain smaller polyphonic sections. You can merge more than two sheets: to play \lstinline!sheet1!, \lstinline!sheet2!, \lstinline!sheet3!\dots at in the same time, just apply the operator to add each sheet: \lstinline!sheet1 / sheet2 / sheet3 /...! Only one rule: every sheet has to have the same total duration.

Monophonic sections can contain everything: bars, crescendo, tempo\dots Just be careful to the scope of the feature, as explained at \ref{sec:scope}.

\me{It's funny.}
\myself{Hm hm. The polyphony is funny. Are you high?}
\begin{meenv}%
Have you ever apply the function \lstinline!length! on a sheet?
\begin{lstlisting}
>> NoteInit
>> sheet1 = [ C:N4 D:N4 E:N4 F:N4 ];
>> length( sheet1 )

ans =

     4

>> sheet2 = [ G:N4 A:N4 B:N4 +C:N4 ];
>> length( sheet2 )

ans =

     4

\end{lstlisting}
Nothing wrong. But:
\begin{lstlisting}
>> length( sheet1 / sheet2 )

ans =

    11

\end{lstlisting}
Where come from the $3$ extra notes?%
\end{meenv}
\myself{Well, \cacofonix uses extra special notes to know where starts a polyphonic section. It's not a big deal: this kind a ghost notes are really rare and it's completely transparent for you. Why would you apply \lstinline!length! on a sheet anyway?}
\begin{meenv}%
No reason. I guess I was boring. But, wait\dots If sometimes notes are added, it's pretty hazardous to use indexation like \lstinline!mysheet(5:25)!. How to get safely an extract of a sheet?%
\end{meenv}
\myself{It's the first time I hear you speak about safety, but, well, get a look at the section \ref{sec:Extraction}.} 

\subsection{Sustain}
\label{sec:Sustain}

For some instruments (piano, essentially) you can manage (press or release) a sustain pedal. Just add the special note \lstinline!Note('Sustain', 'on')! when you want activate the sustain and \lstinline!Note('Sustain', 'off')! when you don't want sustain anymore.

If a \lstinline!Note('Sustain', 'on')! is added, the \cacofonix function adds automatically a \lstinline!Note('Sustain', 'off')! if no one as been specify before.

Sustain is a feature with a channel scope.

\begin{lilypond}
\new GrandStaff <<
\new Staff { \set Staff.pedalSustainStyle = #'mixed \key fis \minor \clef treble \relative c' { \time 2/4 cis4.\(\sustainOn fis8\) a4.\(\sustainOff\sustainOn fis8\) eis4.\(\sustainOff\sustainOn fis16 gis16\) fis2\sustainOff\sustainOn } }
\new Staff { \key fis \minor \clef bass \relative c, { \time 2/4 fis8( <a cis a'>\arpeggio\staccato) cis,\staccato <cis' a'>\staccato fis,( <a cis a'>\arpeggio\staccato) cis,\staccato <cis' a'>\staccato fis,( <b d b'>\arpeggio\staccato) b,\staccato <d' b'>\staccato fis,( <a cis a'>\arpeggio\staccato) cis,\staccato <cis' a'>\staccato } } >>
\end{lilypond}

\begin{lstlisting}
NoteInit

SusOn = Note( 'Sustain', 'on' );
SusOff = Note( 'Sustain', 'off' );

sheet = [ Note([2 4]) ...
	SusOn Cs:N4' ~Fs:N8 bar ...
	SusOn A:N4' ~Fs:N8 bar ...
	SusOn Es:N4' ~Fs:N16 Gs:N16 bar ...
	SusOn Fs:N2 SusOff bar ...
	] / [ Note('--') ...
	Fs:N8 ~A++Cs++A:'$.':N8 Cs:'.':N8 +Cs++A:'.':N8 bar ...
	Fs:N8 ~A++Cs++A:'$.':N8 Cs:'.':N8 +Cs++A:'.':N8 bar ...
	Fs:N8 ~B++D++Gs:'$.':N8 -B:'.':N8 +D++Gs:'.':N8 bar ...
	Fs:N8 ~A++Cs++A:'$.':N8 Cs:'.':N8 +Cs++A:'.':N8 bar ];

cacofonix( 'HungarianDanceN5', 'Tempo', 100, sheet );
\end{lstlisting}

\subsection{Markers}
\label{sec:Markers}

Makers are useful to organize your sheets. To add a marker labeled \emph{mymarker} in the sheet, add the special note \lstinline!Note('Marker', 'mymarker')! at the right place.

When a marker is read, \cacofonix checks if a previous sheet (or a previous monophonic section) has defined a marker at the same place with the same label. If no marker is found, and no marker has been created after, the new marker is recorder, else an error is thrown.
\me{In brief, all sheets bring markers into line with the first.}

Marker can be used everywhere in the sheet, but it's common to place it at the start of a mesure. If you study carefully the paragraph above, you can deduce that markers are optional, but in the first sheet.

\begin{lilypond}
\new GrandStaff <<
\new Staff { \key c \major \time 4/4 \relative c' { c4^\markup{ A } c g' g a a g2 f4^\markup{ B } f e e d d c2 } }
\new Staff { \key c \major \time 4/4 \clef bass \relative c { c4 <e g> c <e g> f <a c> e <g c> f <a c> e <g c> d <g b> <c, e g>2 } } >>
\end{lilypond}

\begin{lstlisting}
>> NoteInit
>> markA = Note( 'Marker', 'A' );
>> markB = Note( 'Marker', 'B' );
>> sheet1 = [ ...
	markA C:N4 C:N4 G:N4 G:N4 bar ...
	A:N4 A:N4 G:N2 bar ...
	markB F:N4 F:N4 E:N4 E:N4 bar ...
	D:N4 D:N4 C:N2 bar ];
>> sheet2 = [ Note('-') ...
	C:N4 E+G:N4 C:N4 E+G:N4 bar ...
	F:N4 A++C:N4 E:N4 G++C:N4 bar ...
	markB F:N4 A++C:N4 E:N4 G++C:N4 bar ...
	D:N4 G+B:N4 C+E+G:N2 bar ];
>> cacofonix( 'TinkleTinkleLittleStar', 'Tempo', 120, ...
	'Piccolo', sheet1, ...
	'Acoustic Bass', sheet2 );
\end{lstlisting}

Markers are very useful when \cacofonix crashes: the error message gives the problematic measure in function of the last marker read.

\subsubsection{Go to a marker}
\label{sec:Goto}

Sometimes, a sheet contains a long pause of several measures. Of course, you can fill theses measures with rests, but it can be more convenient to use a special note with the meaning ``From now and to this marker, don't play anything''. This kind of note is called a \emph{goto} marker\footnote{The name comes from of the famous instruction of BASIC.} and can be created by two ways: 
\begin{lstlisting}
>> gotomarker = Note( 'Marker*', 'mymarker' );
\end{lstlisting}
or
\begin{lstlisting}
>> mymarker = Note( 'Marker', 'mymarker' );
>> gotomarker = ~mymarker;
\end{lstlisting}

A goto marker is first a marker: it can be use for an extraction (see the next section) and in monophonic sections. Of course, the first sheet given to the \cacofonix function can not use goto makers.

\begin{lilypond}
\new GrandStaff <<
\new Staff { \key c \major \time 4/4 \relative c' { c4^\markup{ A } c g' g a^\markup{ B } a g2 f4^\markup{ C } f e e d^\markup{ D } d c2 } }
\new Staff { \key c \major \time 4/4 \clef bass \relative c { R1*3 r2 <c e g>2 } } >>
\end{lilypond}

\begin{lstlisting}
>> NoteInit
>> markA = Note( 'Marker', 'A' );
>> markB = Note( 'Marker', 'B' );
>> markC = Note( 'Marker', 'C' );
>> markD = Note( 'Marker', 'D' );
>> sheet1 = [ ...
	markA C:N4 C:N4 G:N4 G:N4 bar ...
	markB A:N4 A:N4 G:N2 bar ...
	markC F:N4 F:N4 E:N4 E:N4 bar ...
	markD D:N4 D:N4 C:N2 bar ];
>> sheet2 = [ ~markD Note('-') ...
	R:N2 C+E+G:N2 bar ];
>> cacofonix( 'TinkleTinkleLittleStar', 'Tempo', 120, ...
	'Piccolo', sheet1, ...
	'Acoustic Bass', sheet2 );
\end{lstlisting}

\subsubsection{Extraction \lstinline!|!}
\label{sec:Extraction}

Sometimes, it can be useful to extract a piece of a sheet which has been already transcode (\eg to play something twice, or to add a coda\dots). This operation can be very complicated with polyphonic sections, so the operator \lstinline!or! (\lstinline!|!) realizes neatly this function.

To extract a sheet from the start to a marker labelled \emph{myMarker}, just execute this code:
\begin{lstlisting}
>> finalSheet = sheet|'myMarker';
\end{lstlisting}
or
\begin{lstlisting}
>> myMarker = Note( 'Marker', 'myMarker' );
>> finalSheet = sheet|myMarker;
\end{lstlisting}
Of course, the markers (or goto markers) have to be present in the sheet, in every monophonic parts at the right place.

In the same way, to extract a piece of sheet, from the marker \emph{myMarker} to the end, execute this code:
\begin{lstlisting}
>> finalSheet = 'myMarker'|sheet;
\end{lstlisting}
or
\begin{lstlisting}
>> myMarker = Note( 'Marker', 'myMarker' );
>> finalSheet = myMarker|sheet;
\end{lstlisting}

So, this is how to extract a piece from a marker to an other: \\
\begin{lilypond}
\new GrandStaff <<
\new Staff { \key c \major \time 4/4 \relative c' { a'^\markup{ B } a g2 f4^\markup{ C } f e e } }
\new Staff { \key c \major \time 4/4 \clef bass \relative c { f4 <a c> e <g c> f <a c> e <g c> } } >>
\end{lilypond}

\begin{lstlisting}
>> NoteInit
>> markA = Note( 'Marker', 'A' );
>> markB = Note( 'Marker', 'B' );
>> markC = Note( 'Marker', 'C' );
>> markD = Note( 'Marker', 'D' );
>> sheet1 = [ ...
	markA C:N4 C:N4 G:N4 G:N4 bar ...
	markB A:N4 A:N4 G:N2 bar ...
	markC F:N4 F:N4 E:N4 E:N4 bar ...
	markD D:N4 D:N4 C:N2 bar ];
>> sheet2 = [ Note('-') ...
	markA C:N4 E+G:N4 C:N4 E+G:N4 bar ...
	markB F:N4 A++C:N4 E:N4 G++C:N4 bar ...
	markC F:N4 A++C:N4 E:N4 G++C:N4 bar ...
	markD D:N4 G+B:N4 C+E+G:N2 bar ];
>> sheet = markB | (sheet1/sheet2) | markD;
\end{lstlisting}

\myself{The markers are included in the extracted sheet. If you are using a player which displays the markers in the midi file, you should see it.}
\me{And if it doesn't?}
\myself{Sometimes, you are a really annoying person.}

\subsection{Pitch}
\label{sec:Pitch}

To do a trill or a portamento, you can modify the pitch of the channel with a \lstinline!Note( 'pitch', value )!. The value is a string corresponding to the number of half steps to add (or to subtract) to the notes. The acceptable characters and their effects on the value are listed on the table \ref{tab:pitchValue}.

\begin{table}
	\centering
	\begin{tabular}{cl}
		\lstinline!'#'! & Add a half step \\
		\lstinline!'+'! & Add a quarter step \\
		\lstinline!'0'! & Add nothing (reset) \\
		\lstinline!'-'! & Subtract a quarter step \\
		\lstinline!'b'! & Subtract a half step \\
	\end{tabular}
	\caption{Characters for the pitch value}
	\label{tab:pitchValue}
\end{table}

Two optional parameters can be given. The first is the transition between the \emph{last} pitch value and the new one.

\myself{Be careful! With a transition, you modify \emph{the previous and the next} notes!}

To add a transition, just specify the name of the transition (see the figure \ref{fig:pitchTransitions}) between the string \lstinline!'pitch'! and the new value: \lstinline!Note( 'pitch', transition, value )!.

\begin{figure}
	\begin{center}
		\begin{subfloatenv}{Transition \lstinline!'none'! (default)}
			\begin{asy}
				displayPitchTransition( pitchTransNone );
			\end{asy}
		\end{subfloatenv} %
		\begin{subfloatenv}{Transition \lstinline!'linear'!}
			\begin{asy}
				displayPitchTransition( pitchTransLinear );
			\end{asy}
		\end{subfloatenv}
		\begin{subfloatenv}{Transition \lstinline!'quad'!}
			\begin{asy}
				displayPitchTransition( pitchTransQuad );
			\end{asy}
		\end{subfloatenv}%
		\begin{subfloatenv}{Transition \lstinline!'quad2'!}
			\begin{asy}
				displayPitchTransition( pitchTransQuad2 );
			\end{asy}
		\end{subfloatenv}
	\end{center}
	\caption{Pitch transitions}
	\label{fig:pitchTransitions}
\end{figure}

The second optional argument is the delay: like dynamics, if a delay is given (a number or a duration note), the note will be effective only after this duration. The delay is placed after the value: \lstinline!Note( 'pitch', value, delay )!.

The next example is maybe the most complicated demonstration of this document. The trill (lines 6 to 12) is an array of \emph{pitch} notes, where each \note has alternatively the value \lstinline!'b'! and \lstinline!'#'! and with an increasing delay. In the final midi file, the trill speeds up because of the fermata. The portamento (lines 14 to 16) is simply two \emph{pitch} notes: the first rises the pitch up of 29 half steps, and the second reset the pitch value. As you can see in the sheet, the trill is placed before the modified note whereas the portamento is placed after. \\
\begin{lilypond}
\new Staff { \tempo 4=80 \clef treble \key bes \major \time 4/4 \relative c {
f2\fermata\startTrillSpan\mf( f4) f4\stopTrillSpan \glissando
bes''2-> \appoggiatura { aes16[ bes] } \times 2/3 { aes8-. ges-. aes-. } \times 2/3 { ges-. aes-. ges-. }
f8-- ees-- d-- des--( des) ees-- e-- f--(
f)\< d bes32( c bes a) aes8->( aes)\> ges f f->\!(
f1) } }
\end{lilypond}

\begin{lstlisting}
NoteInit
N24 = Note(1/6);
N32 = Note(1/8);
N48 = Note(1/12);

delay = N8; val = { 'b', '#' };
trill = Note( 'pitch', val{1}, delay);
for t = 1:20
	delay = delay+N32;
	trill = [ trill ...
		Note( 'pitch', 'quad', val{1+mod(t,2)}, delay) ];
end

portamento = [ ...
	Note( 'pitch', 'quad', repmat('#',1,29) ) ...
	Note( 'pitch', '0' ) ];

sheet = [ ...
	Note('fermata', N2, N2') trill -F:N2' ...
		Note( 'pitch', '0' ) -F:N4 portamento bar ...
	+Bf:'>':N2 ~[ +Af:N48 +Bf:N48 +Af:'.':N24 ] ...
		+Gf:'.':N12 +Af:'.':N12 ...
		+Gf:'.':N12 +Af:'.':N12 +Gf:'.':N12 bar ...
	+F:'-':N8 +Ef:'-':N8 +D:'-':N8 +Df:'-':N4 ...
		+Ef:'-':N8 +E:'-':N8 +F:'-':N8 bar ...
	Note('cresc',B,'f') ~+F:N8 +D:N8 ...
		~[Bf:N32 +C:N32 Bf:N32 A:N32] ...
		Note('cresc',B,'mf') Af:'>':N8 ...
		~Af:N8 Gf:N8 F:N8 F:'>':N8 bar ...
	~F:N bar ];

cacofonix( 'RhapsodyInBlue', ...
	'Tempo', 80, ...
	'Clarinet', sheet );
\end{lstlisting}

\subsection{Display}
\label{sec:Display}

The \lstinline!display! function has been overloaded: it can be used to display a sheet or a vector of \note without duration.

\subsection{Transpose \lstinline!\^!}
\label{sec:Transpose}

To talk about transposition, we need to look briefly the display of a sheet:
\begin{lstlisting}
>> NoteInit
>> Note.setNbCharByQuater( 6 )
>> sheet = [ C D Ef Gs ]
$|  C  |  D  | Eb  | G#  $
\end{lstlisting}
So, OK: the display shows the name of the notes which are contained in an array, with a \lstinline!b! for a flat and \lstinline!#! for a sharp. What about chord?
\begin{lstlisting}
>> sheet = [ C+D Ef+Gs ]
$| CD  |EbG# $
\end{lstlisting}
For chord, the names are simply concatenated. More precisions are in the section \ref{sec:Display} but for transpositions, it will be enough.

Let's go.

\paragraph{}

We can transpose a \note or a sheet with the operator \lstinline!mpower! (\lstinline!^!). Two way are possible. The first is use \lstinline!^! with the number of half steps to transpose.
For example, we have the scale of B flat major:
\begin{lstlisting}
>> scale = [ -Bf C D Ef F G A ]
$|  Bb  |  C   |  D   |  Eb  |  F   |  G   |  A   $
\end{lstlisting}
And we want transpose this scale in G major. To do that, each note have to be reduced of $3$ half steps (or raised of $9$ half steps). Remember the scale steps!
\begin{center}
\begin{tabular}{rccccccccccccccc}
degrees    & C &   & D &   & E &   & F &   & G &   & A &   & B &   & C \\
half steps &   & 2 &   & 2 &   & 1 &   & 2 &   & 2 &   & 2 &   & 1 & \\
\end{tabular}
\end{center}
\begin{lstlisting}
>> scale^-3
$|  G   |  A   |  B   |  C   |  D   |  E   |  F#  $
>> scale^9
$|  G   |  A   |  B   |  C   |  D   |  E   |  F#  $
\end{lstlisting}
The second solution is one octave higher than the first.

When \lstinline!^! is used only with a double, \cacofonix searches basically the name the most likely. So, in our example, raise \lstinline!scale! of $3$ half steps will make the scale of D flat major (five flats at the key), not the scale of C sharp major (seven sharps at the key):
\begin{lstlisting}
>> scale^3
$|  Db  |  Eb  |  F   |  Gb  |  Ab  |  Bb  |  C   $
\end{lstlisting}
To obtain the scale of C sharp major, you have to use \lstinline!^! with a small vector of two elements: one for number the degree and one for the number of half steps from the new degree. In our case, B flat major to C sharp major, you have to raise of one degree and one half step:
\begin{lstlisting}
>> scale^[1 1]
$|  C#  |  D#  |  E#  |  F#  |  G#  |  A#  |  B#  $
\end{lstlisting}
Of course, the number of degree and the number of half step are algebraic: they can be positive or negative. This is some examples, funny or not:
\begin{lstlisting}
>> scale^[0 0]
$|  Bb  |  C   |  D   |  Eb  |  F   |  G   |  A   $
>> scale^[-2 0]
$|  G   |  A   |  B   |  C   |  D   |  E   |  F#  $
>> scale^[9 -1]
$|  Db  |  Eb  |  F   |  Gb  |  Ab  |  Bb  |  C   $
>> scale^[0 -2]
$| B3b  | Cbb  | Dbb  | E3b  | Fbb  | Gbb  | Abb  $
\end{lstlisting}

\me{Why a transposition operator? It's really useful?}
\myself{Sometimes, you have the sheets directly transposed for an instrument, a clarinet in B flat for example. With this operator, you can transcode your sheet as it's written in your paper version and get the \emph{real} notes in one command line. But, and that's why \cacofonix kicks ass, the operator is in fact essentially used on void notes to create \emph{virtual} chords. You can see examples in \noteInitFile, but we will explain that latter more clearly.}
%\myself{It's not as complicated as it seems. The key is in the breath.}

\subsection{Repeat / Riff \lstinline!.*!}
\label{sec:RepeatRiff}

\subsection{The void note}
\label{sec:VoidNote}

\me{Before start, a little mood music.}

\vspace{ 0.25in }

\begin{center}
\begin{lilypond}
\paper { line-width = 106\mm }
\layout { indent = 2.0\cm }
\header{
	title = "Symphony No. 5"
	composer = "Beethoven"
}
\score { <<
\new Staff { 
	\set Staff.instrumentName = \markup \center-column { Violin, \line { Clarinet } }
	\clef treble \key es \major \time 2/4 \relative c'' { r8 g\ff[ g g] es2\fermata r8 f[ f f] d2( d2\fermata) }
}
\new Staff {
	\set Staff.instrumentName = \markup \center-column { Viol, \line { Cello, } \line { \concat{ Bass } } }
	\clef bass \key es \major \partcombine { \relative c' { r8 g[ g g] es2\fermata r8 f[ f f] d2( d2\fermata) } } { \relative c { r8 g[ g g] es2 r8 f[ f f] d2( d2) } }
}
>> }
\end{lilypond}
\end{center}

\vspace{ 0.25in }

\myself{And, as recommended by \emph{The Hitchhiker's Guide to the Galaxy}, \textsc{don't panic}. \rightthumbsup}

\subsubsection{Expand \lstinline!*!}
\label{sec:Expand}

\subsubsection{Index \lstinline!-!}
\label{sec:Index}

\subsection{Function \lstinline!cacofonix!}
\label{sec:CacofonixFunction}

\subsubsection{The Main sheet}
\label{sec:MainSheet}

\subsubsection{Percussions}
\label{sec:Percussions}

\end{document}
